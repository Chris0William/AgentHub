~~~markdown
# 项目需求文档

## 项目概述
- 名称：智能Agent平台
- 技术栈：C# + ASP.NET Core + Semantic Kernel
- 目标：构建可切换模式的AI助手系统

## 核心功能
1. 多模式切换（基金股票分析、健康医疗、玄学命理）
2. 首期实现：玄学/命理助手
3. Web API接口 + 前端界面
4. 工具集成能力（MCP、自定义工具等）
5. 智能化特性（深度思考、多轮对话、上下文管理、意图识别）

## 技术要求
- 使用Semantic Kernel作为AI编排框架
- 支持多种LLM API（OpenAI、Claude、千问）
- 实现插件化架构，便于扩展新模式
- 包含完整的错误处理和日志记录
```

### 二、分阶段任务拆解策略

#### **Phase 1：基础架构搭建（第1-3天）**

**给Claude Code的提示词模板：**
```
我要开发一个基于C#和Semantic Kernel的智能Agent系统。

任务1：创建ASP.NET Core Web API项目结构
- 使用.NET 8.0
- 包含以下项目：
  - SmartAgent.API (Web API主项目)
  - SmartAgent.Core (核心业务逻辑)
  - SmartAgent.Infrastructure (基础设施层)
  - SmartAgent.Contracts (接口和DTO定义)
- 配置依赖注入、Swagger、日志（Serilog）
- 添加CORS配置支持前端调用

请生成完整的项目结构和基础配置代码。
```
```
任务2：集成Semantic Kernel
- 安装必要的NuGet包（Microsoft.SemanticKernel等）
- 创建KernelService来管理AI服务
- 实现多LLM提供商支持（OpenAI、Azure OpenAI、Claude）
- 配置模型切换机制
- 创建配置类来管理API密钥

示例配置结构：
{
  "AIProviders": {
    "OpenAI": { "ApiKey": "", "Model": "gpt-4" },
    "Claude": { "ApiKey": "", "Model": "claude-3-opus" },
    "Qwen": { "ApiKey": "", "Endpoint": "", "Model": "qwen-max" }
  }
}
```

#### **Phase 2：Agent核心系统（第4-7天）**

**给Claude Code的提示词：**
```
任务3：设计Agent基础架构
基于Semantic Kernel创建可扩展的Agent系统：

1. 创建IAgent接口：
   - Properties: Name, Description, Mode
   - Methods: ProcessAsync(), GetCapabilities()

2. 创建BaseAgent抽象类
   - 实现基础的对话管理
   - 上下文存储（使用内存或Redis）
   - 工具调用框架

3. 创建AgentManager服务
   - 管理多个Agent实例
   - 处理Agent切换逻辑
   - 维护会话状态

4. 实现消息路由系统
   - 根据用户输入选择合适的Agent
   - 支持显式切换命令

请生成完整的代码实现，包含接口、基类和具体实现。
```
```
任务4：实现玄学命理Agent
创建MetaphysicsAgent类，继承BaseAgent：

功能要求：
1. 八字计算和解析
2. 主动收集用户信息（生日、时辰等）
3. 多轮对话管理
4. 集成以下Semantic Kernel插件：
   - BaziPlugin（八字计算）
   - YiJingPlugin（易经占卜）
   - FortunePlugin（运势分析）

特殊要求：
- 实现用户画像构建
- 保存历史咨询记录
- 支持断点续聊

包含完整的prompt工程，例如：
- 系统提示词设计
- Few-shot示例
- 输出格式化
```

#### **Phase 3：工具和插件系统（第8-10天）**

**给Claude Code的提示词：**
```
任务5：实现Semantic Kernel插件系统
创建可扩展的工具插件架构：

1. 创建插件基础接口IAgentPlugin
2. 实现插件加载器PluginLoader
3. 创建具体插件：
   - WebSearchPlugin（网络搜索）
   - DatabasePlugin（数据存储）
   - CalculatorPlugin（复杂计算）
   - CalendarPlugin（黄历查询）

每个插件都要：
- 支持异步调用
- 包含错误处理
- 返回结构化结果
- 有清晰的功能描述（供LLM理解）

使用Semantic Kernel的原生Function调用方式实现。
```
```
任务6：实现MCP协议支持
虽然MCP主要是Python生态，但我们需要在C#中实现类似功能：

1. 创建ToolRegistry服务
   - 动态注册和发现工具
   - 工具能力描述
   - 参数验证

2. 实现工具调用管道
   - 解析LLM的工具调用请求
   - 执行工具并返回结果
   - 结果注入回对话上下文

3. 创建工具适配器模式
   - 支持REST API工具
   - 支持本地函数工具
   - 支持外部服务集成
```

#### **Phase 4：智能化增强（第11-14天）**

**给Claude Code的提示词：**
```
任务7：实现高级对话管理
增强Agent的智能化能力：

1. 意图识别系统
   - 使用Semantic Kernel的规划器
   - 创建意图分类器
   - 实现意图路由

2. 上下文管理器
   - 短期记忆（当前会话）
   - 长期记忆（用户画像）
   - 工作记忆（任务执行）

3. 思维链（Chain of Thought）实现
   - 在Semantic Kernel中实现ReAct模式
   - 添加推理步骤可视化
   - 实现自我反思机制

4. 多轮对话状态机
   - 定义对话状态
   - 状态转换逻辑
   - 异常状态处理
```

#### **Phase 5：Web API和前端（第15-18天）**

**给Claude Code的提示词：**
```
任务8：完善Web API层
创建RESTful API接口：

1. 控制器设计
   - ChatController（对话接口）
   - AgentController（Agent管理）
   - SessionController（会话管理）
   - ToolController（工具管理）

2. 实时通信支持
   - 集成SignalR for WebSocket
   - 实现流式响应
   - 支持打字效果

3. API模型设计
   - 请求/响应DTO
   - 错误响应格式
   - API版本控制

4. 中间件实现
   - 认证授权
   - 限流控制
   - 请求日志
```
```
任务9：创建前端界面
使用React或Blazor创建Web界面：

1. 基础UI组件
   - 聊天界面
   - 模式切换器
   - 设置面板
   - 历史记录

2. 功能实现
   - 实时消息推送
   - Markdown渲染
   - 代码高亮
   - 文件上传

3. 状态管理
   - 会话状态
   - 用户偏好
   - 主题切换

请提供完整的前端代码，包含样式。
```

### 三、高效使用Claude Code的技巧

#### **1. 迭代式开发**
```
初始提示：
"创建一个简单的八字计算工具类"

迭代优化：
"现在增加天干地支的相生相克逻辑"
"添加大运流年的计算"
"优化性能，使用缓存机制"
```

#### **2. 提供上下文**
```
每次新任务都包含：
- 项目当前结构
- 已完成的功能
- 使用的技术栈
- 遵循的编码规范
```

#### **3. 代码审查模式**
```
"请审查这段代码并提出改进建议：
[粘贴代码]
关注点：
- 性能优化
- 错误处理
- 设计模式应用
- 安全性"
```

#### **4. 测试驱动开发**
```
"为MetaphysicsAgent类编写单元测试：
- 测试八字计算准确性
- 测试多轮对话状态
- 测试异常处理
使用xUnit和Moq框架"
```
~~~

### 五、关键实现要点

#### **1. Semantic Kernel配置示例**

给Claude Code这样的具体示例：

csharp

```csharp
// 我需要一个完整的Semantic Kernel服务配置
// 要求：
// 1. 支持多个LLM提供商
// 2. 动态切换模型
// 3. 包含重试机制
// 4. 日志记录
// 5. 性能监控
```

#### **2. Agent实现模板**

csharp

```csharp
// 创建一个玄学Agent，需要：
// 1. 继承BaseAgent
// 2. 实现命理相关的专业对话
// 3. 集成知识库查询
// 4. 支持个性化建议
// 5. 包含用户信息收集流程
```

### 六、持续优化策略

1. 定期重构
   - 每完成一个阶段，让Claude Code审查并重构代码
2. 性能优化
   - "分析这个Agent的性能瓶颈并提供优化方案"
3. 文档生成
   - "为这个API生成Swagger文档注释"
   - "创建开发者使用指南"
4. 错误处理完善
   - "为所有API端点添加全局异常处理"
   - "实现优雅的错误响应"
