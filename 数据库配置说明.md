# AgentHub 数据库配置说明

## 数据库信息

- **服务器**: 202.104.182.126:39010
- **数据库名**: test_ai
- **用户**: root
- **字符集**: utf8

## 已创建的表

### 1. users (用户表)
- `id` - 用户ID (主键, 自增)
- `Username` - 用户名 (唯一索引)
- `PasswordHash` - 密码哈希
- `Email` - 邮箱 (索引)
- `Phone` - 手机号
- `AvatarUrl` - 头像URL
- `CreatedAt` - 创建时间
- `LastLogin` - 最后登录时间
- `IsActive` - 是否激活

### 2. user_profiles (用户档案表)
- `id` - 档案ID (主键, 自增)
- `UserId` - 用户ID (外键, 唯一)
- **基础信息**:
  - `FullName` - 真实姓名
  - `Gender` - 性别 (Male/Female/Other)
- **出生信息**:
  - `BirthDateTime` - 出生时间(公历)
  - `BirthLunar` - 出生时间(农历)
  - `BirthProvince`, `BirthCity` - 出生地
  - `BirthLongitude`, `BirthLatitude` - 出生地坐标
  - `UseSolarTime` - 是否使用真太阳时
- **扩展信息**:
  - `MaritalStatus` - 婚姻状况
  - `Occupation` - 职业
  - `Education` - 学历
  - `FocusAreasJson` - 关注领域 (JSON)
  - `ImportantEventsJson` - 重要事件 (JSON)
- **命理档案**:
  - `BaziInfoJson` - 八字信息 (JSON)
  - `ZiweiInfoJson` - 紫微信息 (JSON)
  - `AstroInfoJson` - 占星信息 (JSON)
  - `LifePathNumber` - 生命灵数
- `CreatedAt`, `UpdatedAt` - 创建/更新时间

### 3. conversations (会话表)
- `id` - 会话ID (主键, 自增)
- `UserId` - 用户ID (外键)
- `AgentType` - Agent类型 (Metaphysics/Stock/Health)
- `Title` - 会话标题
- `Status` - 会话状态 (Active/Completed/Abandoned)
- `StartedAt` - 开始时间
- `LastMessageAt` - 最后消息时间 (索引)
- `ContextSummary` - 上下文摘要 (压缩后)
- `MetadataJson` - 元数据 (JSON)

**索引**:
- (UserId, Status) - 复合索引
- (LastMessageAt) - 单列索引

### 4. messages (消息表)
- `id` - 消息ID (主键, 自增)
- `ConversationId` - 会话ID (外键)
- `Role` - 角色 (User/Assistant/System/Tool)
- `Content` - 消息内容 (TEXT)
- `MetadataJson` - 元数据 (JSON) - 包含工具调用、图片等
- `TokensUsed` - 消耗Token数
- `ModelVersion` - 模型版本
- `CreatedAt` - 创建时间

**索引**:
- (ConversationId, CreatedAt) - 复合索引

## 迁移历史

### InitialCreate (2025-10-22 09:58:37)
- 创建初始数据库架构
- 创建用户、用户档案、会话、消息4个核心表
- 配置外键约引和索引

## EF Core 命令

### 生成新的迁移
```bash
dotnet ef migrations add <MigrationName> --project src/AgentHub.Infrastructure --startup-project src/AgentHub.API
```

### 应用迁移
```bash
dotnet ef database update --project src/AgentHub.Infrastructure --startup-project src/AgentHub.API
```

### 回滚迁移
```bash
dotnet ef database update <PreviousMigrationName> --project src/AgentHub.Infrastructure --startup-project src/AgentHub.API
```

### 删除最后一个迁移
```bash
dotnet ef migrations remove --project src/AgentHub.Infrastructure --startup-project src/AgentHub.API
```

## 注意事项

1. **时间字段**: 所有时间字段(`CreatedAt`, `UpdatedAt`等)在代码中设置默认值,不依赖数据库默认值
2. **JSON字段**: MySQL 5.7.8+ 支持原生JSON类型
3. **字符集**: 所有表使用UTF8字符集,支持中文和emoji
4. **外键约束**: 所有外键配置了级联删除
5. **密码安全**: 密码使用BCrypt哈希存储,永不明文存储

## API配置位置

配置文件: `src/AgentHub.API/appsettings.json`

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=202.104.182.126;Database=test_ai;..."
  },
  "AI": {
    "Qwen": {
      "ApiKey": "sk-28fe847656e24d7ab17eedbdc75348c2"
    }
  }
}
```

---

**文档更新时间**: 2025-10-22
